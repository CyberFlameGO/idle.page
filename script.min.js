const API="/api",container=document.getElementsByClassName("c")[0],wrapper=document.getElementsByClassName("t")[0],days=document.getElementById("d"),hours=document.getElementById("h"),minutes=document.getElementById("m"),seconds=document.getElementById("s"),millis=document.getElementById("ms");let state={t:0,l:Math.floor(Date.now()/1e3),s:0,m:0,h:0,d:0};async function init(){state=Object.assign({},state,getState()),null!=state&&state.l||(state=Object.assign({},state,await createNew())),console.log(state),saveState(),updateDisplay(),setTimeout((()=>startTicking()),100*Math.random()),container.classList.add("rdy")}function getState(){const t=localStorage.getItem("page");return null==t||void 0===state||t.length<2?null:JSON.parse(t)}function saveState(){localStorage.setItem("page",JSON.stringify(state))}function createNew(){return fetch("/api/new",{method:"GET",credentials:"same-origin"}).then((t=>t.json())).then((t=>(console.log("[new]",t),t)))}function startTicking(){const t=state.l+60,e=Math.max(0,t-Math.floor(Date.now()/1e3));console.log("waiting "+e+"s for first tick"),state.s=60-e,setTimeout((()=>{tick().then((()=>{setInterval((()=>tick()),6e4+10*Math.random())}))}),1e3*e),setInterval((()=>tickSecond()),1e3),setInterval((()=>tickMillis()),12)}function tick(){return fetch("/api/tick/"+state.n+"/"+state.k,{method:"POST",credentials:"same-origin"}).then((t=>t.json())).then((t=>{console.log("[tick]",t),state=Object.assign({},state,t),updateDisplay(),saveState()}))}function tickSecond(){state.s=(state.s||0)+1,state.s>=60&&(state.s=0,state.t++),state.m=state.t%60,state.h=Math.floor(state.t/60)%60,state.d=Math.floor(state.t/60/24),updateDisplay()}function tickMillis(){state.ms=(state.ms||0)+12,state.ms>=1e3&&(state.ms=0),millis.innerText=pad(`${state.ms}`,3)}function updateDisplay(){state.h>0&&wrapper.classList.add("h"),state.d>0&&wrapper.classList.add("d"),days.innerText=`${state.d}`,hours.innerText=pad(`${state.h}`,2),minutes.innerText=pad(`${state.m}`,2),seconds.innerText=pad(`${state.s}`,2),millis.innerText=pad(`${state.ms}`,3)}function pad(t,e){for(;t.length<e;)t="0"+t;return t}setTimeout((()=>init()),50*Math.random());
