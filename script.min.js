const API="/api",container=document.getElementsByClassName("c")[0],wrapper=document.getElementsByClassName("t")[0],days=document.getElementById("d"),hours=document.getElementById("h"),minutes=document.getElementById("m"),seconds=document.getElementById("s"),millis=document.getElementById("ms");let state={t:0,l:Math.floor(Date.now()/1e3),s:0,m:0,h:0,d:0},firstTick=!0;async function init(){null!=(state=Object.assign({},state,getState()))&&state.l||(backupState(),state=Object.assign({},state,await createNew())),console.log(state),saveState(),updateDisplay(),setTimeout(()=>startTicking(),100*Math.random()),container.classList.add("rdy")}function getState(){const t=localStorage.getItem("page");return null==t||void 0===state||t.length<2?null:JSON.parse(t)}function saveState(){localStorage.setItem("page",JSON.stringify(state))}function backupState(){const t=new Date;localStorage.setItem("page__"+t.getFullYear()+"_"+t.getMonth()+"_"+t.getDate()+"__"+Math.round(500*Math.random()+500*Math.random()),localStorage.getItem("page"))}function createNew(){return fetch(API+"/new/"+Math.floor(Date.now()/1e3/60).toString(36),{method:"GET",credentials:"same-origin"}).then(t=>t.json()).then(t=>(console.log("[new]",t),t)).catch(t=>{console.error("[new]",t)})}function startTicking(){const t=state.l+60,e=Math.max(0,t-Math.floor(Date.now()/1e3));console.log("waiting "+e+"s for first tick"),state.s=60-e,setTimeout(()=>{tick().then(()=>{setInterval(()=>tick(),6e4+10*Math.random())})},1e3*e),setInterval(()=>tickSecond(),1e3),setInterval(()=>tickMillis(),12)}function tick(){return fetch(API+"/tick/"+state.n+"/"+state.k,{method:"POST",credentials:"same-origin"}).then(t=>t.json()).then(t=>{if(console.log("[tick]",t),3===t.e)return console.warn("[tick] invalid session"),void setTimeout(()=>{window.location.reload()},100);state=Object.assign({},state,t),updateDisplay(),saveState()}).catch(t=>{console.error("[tick]",t)})}function tickSecond(){state.s=(state.s||0)+1,state.s>=60&&(state.s=0,state.t++);const t=state.m,e=state.h,a=state.d;state.m=state.t%60,state.h=Math.floor(state.t/60)%60,state.d=Math.floor(state.t/60/24),updateDisplay(),firstTick||(state.m>t&&spawnOrb("+1",minutes),state.h>e&&spawnOrb("+1",hours),state.d>a&&spawnOrb("+1",days)),firstTick=!1}function tickMillis(){state.ms=(state.ms||0)+12,state.ms>=1e3&&(state.ms=0),millis.innerText=pad(`${state.ms}`,3)}function updateDisplay(){state.h>0&&wrapper.classList.add("h"),state.d>0&&wrapper.classList.add("d"),days.innerText=`${state.d}`,hours.innerText=pad(`${state.h}`,2),minutes.innerText=pad(`${state.m}`,2),seconds.innerText=pad(`${state.s}`,2),millis.innerText=pad(`${state.ms}`,3)}function spawnOrb(t,e){const a=document.createElement("div");a.innerText=t,a.classList.add("o");const s=e.offsetLeft+e.offsetWidth/2+(Math.random()*e.offsetWidth/2-Math.random()*e.offsetWidth/2);a.style.top=e.offsetTop+e.offsetHeight/4+"px",a.style.left=s+"px",a.classList.add("a"),document.body.prepend(a),setTimeout(()=>{document.body.removeChild(a)},1e4)}function loadLeaderboard(){return fetch(API+"/leaderboard").then(t=>t.json()).then(t=>{const e=document.getElementById("l");e.innerText="";for(let a=0;a<t.length;a++){const s=document.createElement("div");e.append(s),s.innerText=`#${a+1} ${t[a].n} ${t[a].t}m`}})}function pad(t,e){for(;t.length<e;)t="0"+t;return t}document.querySelector("a.l").addEventListener("click",t=>{t.preventDefault(),loadLeaderboard().then(()=>{document.querySelector("div.l").classList.add("v")})}),document.addEventListener("click",t=>{document.querySelector("div.l").classList.remove("v")}),setTimeout(()=>init(),50*Math.random());
